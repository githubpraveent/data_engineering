{
  "name": "lakehouse_medallion_pipeline",
  "email_notifications": {
    "on_success": ["data-engineering@company.com"],
    "on_failure": ["data-engineering@company.com", "oncall@company.com"],
    "on_start": []
  },
  "timeout_seconds": 3600,
  "max_concurrent_runs": 1,
  "format": "MULTI_TASK",
  "tasks": [
    {
      "task_key": "bronze_ingestion",
      "description": "Stream data from Kafka to Bronze layer",
      "notebook_task": {
        "notebook_path": "/Shared/lakehouse/notebooks/01_bronze_ingestion",
        "base_parameters": {
          "workspace_config": "/Workspace/Shared/lakehouse/config/workspace_config.json"
        }
      },
      "job_cluster_key": "streaming_cluster",
      "timeout_seconds": 3600,
      "max_retries": 3,
      "min_retry_interval_millis": 60000,
      "retry_on_timeout": true
    },
    {
      "task_key": "silver_transformation",
      "description": "Transform Bronze to Silver with cleaning and enrichment",
      "depends_on": [
        {
          "task_key": "bronze_ingestion"
        }
      ],
      "notebook_task": {
        "notebook_path": "/Shared/lakehouse/notebooks/02_silver_transformation",
        "base_parameters": {
          "workspace_config": "/Workspace/Shared/lakehouse/config/workspace_config.json"
        }
      },
      "job_cluster_key": "streaming_cluster",
      "timeout_seconds": 3600,
      "max_retries": 3
    },
    {
      "task_key": "gold_aggregation",
      "description": "Create Gold layer aggregations",
      "depends_on": [
        {
          "task_key": "silver_transformation"
        }
      ],
      "notebook_task": {
        "notebook_path": "/Shared/lakehouse/notebooks/03_gold_aggregation",
        "base_parameters": {
          "workspace_config": "/Workspace/Shared/lakehouse/config/workspace_config.json"
        }
      },
      "job_cluster_key": "analytics_cluster",
      "timeout_seconds": 1800,
      "max_retries": 2
    },
    {
      "task_key": "ml_inference",
      "description": "Run ML inference on Silver data",
      "depends_on": [
        {
          "task_key": "silver_transformation"
        }
      ],
      "notebook_task": {
        "notebook_path": "/Shared/lakehouse/notebooks/05_ml_inference",
        "base_parameters": {
          "workspace_config": "/Workspace/Shared/lakehouse/config/workspace_config.json",
          "model_name": "customer_sentiment_classifier",
          "model_stage": "Production"
        }
      },
      "job_cluster_key": "ml_cluster",
      "timeout_seconds": 1800,
      "max_retries": 2
    },
    {
      "task_key": "monitoring",
      "description": "Run monitoring and alerting checks",
      "depends_on": [
        {
          "task_key": "gold_aggregation"
        },
        {
          "task_key": "ml_inference"
        }
      ],
      "notebook_task": {
        "notebook_path": "/Shared/lakehouse/notebooks/07_monitoring",
        "base_parameters": {
          "workspace_config": "/Workspace/Shared/lakehouse/config/workspace_config.json"
        }
      },
      "job_cluster_key": "analytics_cluster",
      "timeout_seconds": 600,
      "max_retries": 1
    }
  ],
  "job_clusters": [
    {
      "job_cluster_key": "streaming_cluster",
      "new_cluster": {
        "cluster_name": "streaming-cluster",
        "spark_version": "14.3.x-scala2.12",
        "node_type_id": "i3.xlarge",
        "driver_node_type_id": "i3.xlarge",
        "num_workers": 2,
        "spark_conf": {
          "spark.databricks.delta.optimizeWrite.enabled": "true",
          "spark.databricks.delta.autoCompact.enabled": "true",
          "spark.sql.streaming.checkpointLocation": "s3://databricks-lakehouse/checkpoints/"
        },
        "custom_tags": {
          "ResourceClass": "Streaming",
          "Environment": "Production"
        }
      }
    },
    {
      "job_cluster_key": "analytics_cluster",
      "new_cluster": {
        "cluster_name": "analytics-cluster",
        "spark_version": "14.3.x-scala2.12",
        "node_type_id": "i3.xlarge",
        "driver_node_type_id": "i3.xlarge",
        "num_workers": 2,
        "spark_conf": {
          "spark.databricks.delta.optimizeWrite.enabled": "true"
        },
        "custom_tags": {
          "ResourceClass": "Analytics",
          "Environment": "Production"
        }
      }
    },
    {
      "job_cluster_key": "ml_cluster",
      "new_cluster": {
        "cluster_name": "ml-cluster",
        "spark_version": "14.3.x-scala2.12",
        "node_type_id": "g4dn.xlarge",
        "driver_node_type_id": "g4dn.xlarge",
        "num_workers": 1,
        "spark_conf": {
          "spark.databricks.mlflow.trackingUri": "databricks"
        },
        "custom_tags": {
          "ResourceClass": "ML",
          "Environment": "Production"
        }
      }
    }
  ],
  "schedule": {
    "quartz_cron_expression": "0 */15 * * * ?",
    "timezone_id": "America/New_York",
    "pause_status": "UNPAUSED"
  },
  "max_clusters": 3
}
