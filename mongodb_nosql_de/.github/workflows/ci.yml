name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  PYTHON_VERSION: '3.9'
  TERRAFORM_VERSION: '1.6.0'
  ANSIBLE_VERSION: '8.0.0'

jobs:
  code-validation:
    name: Code Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install black flake8 mypy pytest pytest-cov

      - name: Run Black (code formatting check)
        run: black --check src/ tests/

      - name: Run Flake8 (linting)
        run: flake8 src/ tests/ --max-line-length=120 --exclude=__pycache__,venv

      - name: Run MyPy (type checking)
        run: mypy src/ --ignore-missing-imports || true

      - name: Run unit tests
        run: |
          pytest tests/unit/ -v --cov=src --cov-report=xml --cov-report=term

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          fail_ci_if_error: false

  terraform-validation:
    name: Terraform Validation
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: terraform

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Format Check
        run: terraform fmt -check -recursive

      - name: Terraform Init
        run: terraform init -backend=false
        working-directory: terraform/environments/staging

      - name: Terraform Validate
        run: terraform validate
        working-directory: terraform/environments/staging

      - name: Install TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: latest

      - name: Run TFLint
        run: tflint --init && tflint --recursive

      - name: Install Checkov
        run: pip install checkov

      - name: Run Checkov Security Scan
        run: checkov -d terraform --framework terraform --quiet
        continue-on-error: true

  ansible-validation:
    name: Ansible Validation
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ansible

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Ansible
        run: |
          pip install ansible==${{ env.ANSIBLE_VERSION }}
          pip install ansible-lint yamllint

      - name: Ansible Lint
        run: ansible-lint playbooks/ roles/

      - name: YAML Lint
        run: yamllint .

      - name: Ansible Syntax Check
        run: |
          ansible-playbook --syntax-check playbooks/site.yml
          ansible-playbook --syntax-check playbooks/deploy-pipeline.yml

      - name: Ansible Idempotency Test
        run: |
          # Mock inventory for testing
          echo "localhost ansible_connection=local" > /tmp/test_inventory
          ansible-playbook -i /tmp/test_inventory --check playbooks/site.yml || true

  data-quality-tests:
    name: Data Quality Tests
    runs-on: ubuntu-latest

    services:
      mongodb:
        image: mongo:6.0
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.runCommand({ping: 1})'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run data quality tests
        env:
          MONGODB_URI: mongodb://localhost:27017/test_db
        run: pytest tests/quality/ -v

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [code-validation, terraform-validation, ansible-validation]

    services:
      mongodb:
        image: mongo:6.0
        ports:
          - 27017:27017

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run integration tests
        env:
          MONGODB_URI: mongodb://localhost:27017/test_db
        run: pytest tests/integration/ -v
